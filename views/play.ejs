<div class="game-container">
  <div class="game-header">
    <h2><%= game.title %></h2>
    <button id="fullscreen-toggle" class="btn">Fullscreen</button>
  </div>

  <div class="game-wrapper">
    <div id="game-frame-container">
      <iframe
        id="game-frame"
        src="<%= game.gameUrl %>"
        allow="fullscreen; autoplay; clipboard-write; encrypted-media; picture-in-picture"
        sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
        allowfullscreen
        frameborder="0"
      ></iframe>
    </div>

    <div id="game-chat-container">
      <div id="chat-header">
        <input
          type="text"
          id="username-input"
          placeholder="Wähle deinen Username..."
          class="retro-input"
        />
      </div>
      <div id="chat-messages"></div>
      <form id="chat-form" onsubmit="return false;">
        <div class="chat-input-container">
          <input
            type="text"
            id="chat-input"
            placeholder="Deine Nachricht..."
            autocomplete="off"
            class="retro-input"
          />
          <button type="submit" class="send-button">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .game-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .game-wrapper {
    display: flex;
    gap: 20px;
    height: 600px;
  }

  #game-frame-container {
    flex: 1;
    position: relative;
    background: #000;
    border: 2px solid #00ff00;
    border-radius: 5px;
  }

  #game-frame {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
  }

  #game-chat-container {
    width: 300px;
    display: flex;
    flex-direction: column;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid #00ff00;
    border-radius: 5px;
  }

  #chat-header {
    padding: 10px;
    border-bottom: 1px solid #00ff00;
  }

  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    color: #00ff00;
    font-family: "Press Start 2P", cursive;
    font-size: 10px;
  }

  #chat-form {
    padding: 10px;
    border-top: 1px solid #00ff00;
  }

  .retro-input {
    width: 100%;
    padding: 5px;
    background: black;
    color: #00ff00;
    border: 1px solid #00ff00;
    font-family: "Press Start 2P", cursive;
    font-size: 10px;
  }

  .message {
    margin-bottom: 5px;
  }

  .username {
    color: #ff00ff;
  }

  .timestamp {
    color: #666;
    font-size: 8px;
  }

  /* Vollbildmodus Styles */
  .fullscreen #game-frame-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
  }

  .fullscreen #game-chat-container {
    position: fixed;
    top: 20px;
    right: 20px;
    height: calc(100vh - 40px);
    z-index: 10000;
  }

  .fullscreen #fullscreen-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 10000;
  }

  .chat-input-container {
    display: flex;
    gap: 10px;
  }

  .chat-input-container input {
    flex: 1;
  }

  .send-button {
    background: #00ff00;
    color: black;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    font-family: "Press Start 2P", cursive;
    font-size: 10px;
    border-radius: 3px;
  }

  .send-button:hover {
    background: #00cc00;
  }

  /* Zusätzliche Styles für Systembenachrichtigungen */
  .message.system {
    color: #999;
    font-style: italic;
    font-size: 8px;
  }

  .message.error {
    color: #ff0000;
    font-style: italic;
    font-size: 8px;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    let socket;
    let socketConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const gameId = window.location.pathname.split("/")[2];
    const isVercel = window.location.hostname.includes("vercel.app");

    console.log("Chat initialisiert für Spiel:", gameId);
    console.log("Umgebung:", isVercel ? "Vercel" : "Lokal");

    // Status-Element für Verbindungsinformationen
    const addStatusMessage = (message, isError = false) => {
      try {
        const chatMessages = document.getElementById("chat-messages");
        if (!chatMessages) return;

        const statusEl = document.createElement("div");
        statusEl.className = `message ${isError ? "error" : "system"}`;
        statusEl.textContent = message;
        chatMessages.appendChild(statusEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (err) {
        console.error("Fehler beim Anzeigen der Statusmeldung:", err);
      }
    };

    // Rekursive Funktion zum Aufbauen der Socket-Verbindung
    const connectSocket = async (attempt = 0) => {
      try {
        if (attempt > 0) {
          addStatusMessage(`Verbindungsversuch ${attempt}...`);
        }

        // Health Check für Socket.IO-Endpunkt
        try {
          const response = await fetch("/api/socketio");
          const data = await response.json();
          console.log("Socket.IO Health Check:", data);
        } catch (error) {
          console.error("Socket.IO-Endpunkt nicht erreichbar:", error);
        }

        const socketOptions = {
          transports: ["polling", "websocket"],
          reconnectionAttempts: 3,
          reconnectionDelay: 1000,
          timeout: 10000,
          forceNew: true,
          autoConnect: true,
        };

        // Vercel-spezifische Konfiguration
        if (isVercel) {
          socketOptions.path = "/api/socketio";
        }

        // Verbindung herstellen
        socket = io(socketOptions);

        // Event-Listener für Verbindungsereignisse
        socket.on("connect", () => {
          console.log("Socket verbunden:", socket.id);
          socketConnected = true;
          addStatusMessage("Verbindung hergestellt");

          // Spiel-Raum beitreten
          socket.emit("join game", gameId);
        });

        // Ping-Pong zur Verbindungsprüfung
        socket.on("ping", () => {
          console.log("Ping erhalten, sende Pong");
          if (socket.connected) socket.emit("pong");
        });

        socket.on("pong", () => {
          console.log("Pong erhalten - Verbindung aktiv");
        });

        socket.on("connect_error", (error) => {
          console.error("Socket Verbindungsfehler:", error);
          socketConnected = false;

          if (attempt < maxReconnectAttempts) {
            // Automatischer Wiederverbindungsversuch
            setTimeout(() => connectSocket(attempt + 1), 2000);
          } else {
            addStatusMessage(
              `Verbindungsfehler: ${
                error.message || "Serververbindung fehlgeschlagen"
              }`,
              true
            );
          }
        });

        socket.on("error", (error) => {
          console.error("Socket Fehler:", error);
          addStatusMessage(`Socket Fehler: ${error}`, true);
        });

        socket.on("disconnect", (reason) => {
          console.log("Socket getrennt, Grund:", reason);
          socketConnected = false;
          addStatusMessage(`Verbindung getrennt: ${reason}`);

          // Automatische Wiederverbindung bei bestimmten Gründen
          if (
            reason === "io server disconnect" ||
            reason === "transport close"
          ) {
            if (reconnectAttempts < maxReconnectAttempts) {
              reconnectAttempts++;
              addStatusMessage(
                `Wiederverbindungsversuch ${reconnectAttempts}...`
              );
              setTimeout(() => socket.connect(), 2000);
            }
          }
        });

        // Event-Listener für Chat-Nachrichten
        setupChatHandlers(socket);
        return socket;
      } catch (error) {
        console.error("Socket.IO Initialisierungsfehler:", error);
        addStatusMessage(`Initialisierungsfehler: ${error.message}`, true);
        return null;
      }
    };

    // Chat-Handler einrichten
    const setupChatHandlers = (socket) => {
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatMessages = document.getElementById("chat-messages");
      const usernameInput = document.getElementById("username-input");
      const fullscreenToggle = document.getElementById("fullscreen-toggle");
      const gameContainer = document.querySelector(".game-container");

      // Sendestatus Anzeige
      const showSendStatus = (message, isError = false) => {
        const statusEl = document.createElement("div");
        statusEl.className = `message ${isError ? "error" : "system"}`;
        statusEl.textContent = message;
        chatMessages.appendChild(statusEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Automatisch entfernen nach 5 Sekunden
        setTimeout(() => {
          try {
            statusEl.remove();
          } catch (e) {}
        }, 5000);
      };

      // Send message function
      const sendMessage = () => {
        const msg = chatInput.value.trim();
        if (!msg) return;

        if (!socket || !socketConnected) {
          showSendStatus(
            "Nicht verbunden! Nachricht kann nicht gesendet werden.",
            true
          );
          return;
        }

        console.log("Sende Nachricht:", { gameId, msg });
        showSendStatus("Sende...");

        // Timeout für Nachrichtenzustellung
        const messageTimeout = setTimeout(() => {
          showSendStatus("Timeout beim Senden", true);
        }, 5000);

        socket.emit("chat message", { gameId, msg }, (ack) => {
          clearTimeout(messageTimeout);

          if (ack && ack.success) {
            showSendStatus("Gesendet!");
          } else if (ack && ack.error) {
            showSendStatus(`Fehler: ${ack.error}`, true);
          } else {
            // Keine Antwort erhalten
            showSendStatus("Keine Bestätigung erhalten", true);
          }
        });

        chatInput.value = "";
        chatInput.focus();
      };

      // Form submit handler
      chatForm.addEventListener("submit", (e) => {
        console.log("Form-Submission erkannt");
        e.preventDefault();
        e.stopPropagation();
        sendMessage();
        return false;
      });

      // Send button handler
      document.querySelector(".send-button").addEventListener("click", (e) => {
        console.log("Send-Button geklickt");
        e.preventDefault();
        e.stopPropagation();
        sendMessage();
        return false;
      });

      // Enter key handler
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          e.stopPropagation();
          sendMessage();
        }
      });

      // Username handling
      const setUsername = (username) => {
        if (!username || !username.trim()) return;

        console.log("Setting username:", username.trim());
        if (socket && socketConnected) {
          socket.emit("set username", username.trim());
        }
        localStorage.setItem("chatUsername", username.trim());
      };

      usernameInput.addEventListener("change", () => {
        setUsername(usernameInput.value);
      });

      usernameInput.addEventListener("blur", () => {
        setUsername(usernameInput.value);
      });

      // Load saved username
      const savedUsername = localStorage.getItem("chatUsername");
      if (savedUsername) {
        usernameInput.value = savedUsername;
        if (socket && socketConnected) {
          setUsername(savedUsername);
        }
      }

      // Fullscreen toggle
      fullscreenToggle.addEventListener("click", () => {
        gameContainer.classList.toggle("fullscreen");
        fullscreenToggle.textContent = gameContainer.classList.contains(
          "fullscreen"
        )
          ? "Normal size"
          : "Fullscreen";
      });

      // Handle incoming messages
      socket.on("chat message", (msg) => {
        console.log("Nachricht erhalten:", msg);
        try {
          if (!msg || !msg.text) {
            console.error("Ungültige Nachricht erhalten:", msg);
            return;
          }

          const div = document.createElement("div");
          div.className = "message";
          const time = new Date(msg.timestamp).toLocaleTimeString();
          div.innerHTML = `
            <span class="timestamp">[${time}]</span>
            <span class="username">${msg.username || "Anonym"}:</span>
            ${msg.text}
          `;
          chatMessages.appendChild(div);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("Fehler beim Anzeigen der Nachricht:", error);
        }
      });

      // Handle previous messages
      socket.on("previous messages", (messages) => {
        console.log("Vorherige Nachrichten geladen:", messages?.length || 0);
        try {
          if (!Array.isArray(messages)) {
            console.error("Ungültiges Nachrichtenformat erhalten:", messages);
            return;
          }

          chatMessages.innerHTML = "";

          if (messages.length === 0) {
            const div = document.createElement("div");
            div.className = "message system";
            div.textContent = "Keine vorherigen Nachrichten";
            chatMessages.appendChild(div);
            return;
          }

          messages.forEach((msg) => {
            if (!msg || !msg.text) return;

            const div = document.createElement("div");
            div.className = "message";
            const time = new Date(msg.timestamp).toLocaleTimeString();
            div.innerHTML = `
              <span class="timestamp">[${time}]</span>
              <span class="username">${msg.username || "Anonym"}:</span>
              ${msg.text}
            `;
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error("Fehler beim Anzeigen vorheriger Nachrichten:", error);
        }
      });
    };

    // Initial Socket verbinden
    addStatusMessage("Verbindung wird hergestellt...");
    await connectSocket();
  });
</script>
